apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: argo-cd
  namespace: argocd
spec:
  destination:
    namespace: argocd
    server: https://kubernetes.default.svc
  project: default
  source:
    path: lab/charts/argo-cd
    repoURL: https://github.com/johnko/homedir.git
    targetRevision: HEAD
    helm:
      values: |
        configs:
          cm:
            # https://codefresh.io/blog/argo-cd-application-dependencies/
            # https://argo-cd.readthedocs.io/en/stable/operator-manual/health/
            resource.customizations: |
              argoproj.io/Application:
                health.lua:
                  hs = {}
                  hs.status = "Progressing"
                  hs.message = ""
                  if obj.status ~= nil then
                    if obj.status.health ~= nil then
                      hs.status = obj.status.health.status
                      if obj.status.health.message ~= nil then
                        hs.message = obj.status.health.message
                      end
                    end
                  end
                  return hs
              # Service:
              #   health.lua:
              #     hs = {}
              #     hs.status = "Progressing"
              #     if obj.status ~= nil then
              #       if obj.status.loadBalancer ~= nil then
              #         hs.status = "Healthy"
              #       end
              #     end
              #     return hs
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
