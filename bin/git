#!/usr/bin/env bash
set -eo pipefail

exit_error() {
    echo "ERROR: detected running in vscode. Aborting."
    exit 1
}

if [[ -n $VSCODE_INJECTION && $VSCODE_INJECTION == "1" ]]; then
  ## if in VSCode, unset SSH_AUTH_SOCK to avoid endless 1Password prompt for ssh-agent
  ## dev container seems to still set it, so we control from ssh wrapper
  export SSH_AUTH_SOCK=""
  export GPG_SIGN=""
  if echo "$@" | grep -q -E '(fetch|pull|push)'; then
    if /usr/bin/git remote -v | grep -q '@'; then
      exit_error
    fi
  fi
  if echo "$@" | grep -q 'clone .*@'; then
    exit_error
  fi
else
  # if not in VSCode, set ssh-agent
  export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"
  if echo "$@" | grep -q -E "(amend|commit|merge|rebase|revert|$(/usr/bin/git config --get-regexp '^alias\.' | grep -E 'amend|commit|rebase|merge|revert' | sed -e 's/^alias\.//g' -e 's/ .*//g' | tr '\n' '|' | sed 's,|$,,'))"; then
    export GPG_SIGN="--gpg-sign"
  fi
fi

# absolute path so we don't get into endless loop
/usr/bin/git "$@" $GPG_SIGN
