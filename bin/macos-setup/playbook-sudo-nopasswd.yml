- hosts: localhost
  connection: local
  become: '{{ lookup("env", "ANSIBLE_BECOME") }}'
  become_user: root
  gather_facts: false
  tasks:
    - name: Allow mac local user to sudo
      lineinfile:
        path: /etc/sudoers.d/50-local-user
        state: present
        create: true
        regexp: '^{{ lookup("env", "USER") }} .* ALL$'
        line: '{{ lookup("env", "USER") }} ALL = (ALL) ALL'
        validate: /usr/sbin/visudo -cf %s
    - name: allow all read
      ansible.builtin.file:
        path: /etc/sudoers.d/50-local-user
        state: file
        mode: '0644'
        owner: root
        group: wheel
    - name: Allow mac local user to sudo NOPASSWD
      lineinfile:
        path: /etc/sudoers.d/50-local-user
        state: '{{ lookup("env", "ANSIBLE_ACTION") }}' # present/absent
        create: true
        regexp: '^{{ lookup("env", "USER") }} .* NOPASSWD:ALL$'
        line: '{{ lookup("env", "USER") }} ALL = (ALL) NOPASSWD:ALL'
        validate: /usr/sbin/visudo -cf %s
