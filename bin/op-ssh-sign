#!/usr/bin/env bash
set -eo pipefail

exit_error() {
  echo "ERROR: detected running in vscode. Aborting."
  exit 1
}

if [[ ! -e "$HOME/.allowed_git_sign" ]]; then
  if [[ -n $VSCODE_INJECTION && $VSCODE_INJECTION == "1" || -n $VSCODE_GIT_IPC_HANDLE || -n $VSCODE_NONCE ]]; then
    if set | grep -v grep | grep -i ASKPASS | grep -q -E '/(Visual Studio Code.app)/'; then
      DETECTED=code
    fi
    if [[ -n $CURSOR_TRACE_ID ]]; then
      DETECTED=cursor
    else
      if set | grep -v grep | grep -i ASKPASS | grep -q -E '/(Cursor.app|.cursor-server)/'; then
        DETECTED=cursor
      fi
    fi
    ## if in VSCode, unset SSH_AUTH_SOCK to avoid endless 1Password prompt for ssh-agent
    ## dev container seems to still set it, so we control from ssh wrapper
    export SSH_AUTH_SOCK=""
    if [[ "cursor" == $DETECTED ]]; then
      exit_error
    fi
  fi
fi

# if not in VSCode (eg Terminal), set ssh-agent
export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"

# absolute path so we don't get into endless loop
/Applications/1Password.app/Contents/MacOS/op-ssh-sign "$@"
